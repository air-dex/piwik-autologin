<?php
/**
 * @file
 * piwik_autologin.module
 * @brief .module file for the Piwik Autologin Drupal module.
 * @author Romain Ducher <r.ducher@agence-codecouleurs.fr>
 * @license https://www.gnu.org/licenses/gpl-3.0.txt
 * @section LICENSE
 *
 * Copyright 2014 Code Couleurs
 *
 * This file is part of Piwik Autologin.
 *
 * Piwik Autologin is free software: you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option)
 * any later version.
 *
 * Piwik Autologin is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS OR A PARTICULAR PURPOSE. See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * Piwik Autologin. If not, see <http://www.gnu.org/licenses/>.
 */

if (!class_exists('PiwikUser')) {
  require_once 'piwik_autologin.piwik_user.inc';
}

/**
 * Implementing "hook_menu".
 */
function piwik_autologin_menu() {
  // Configuration menu.
  $items['admin/config/piwik_autologin'] = array(
    'title' => 'Piwik Autologin Configuration',
    'description' => 'Configuring Piwik Autologin',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('piwik_autologin_admin_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'piwik_autologin.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implementing hook_user_login.
 *
 * Retrieve the Logme URL for Piwik
 * @see https://api.drupal.org/api/drupal/modules!user!user.api.php/function/hook_user_login/7
 */
function piwik_autologin_user_login(&$edit, $account) {
  if ($piwik_user = \piwik_autologin\PiwikUser::getByDrupalUserID($account->uid)) {
    // Saving logme url.
    $_SESSION['piwik_autologin_logme_url'] = $piwik_user->getLogmeURL();
  }
}
